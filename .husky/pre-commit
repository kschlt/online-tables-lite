#!/bin/bash

# Pre-commit hook for Online Tables Lite (Husky)
# Runs quality checks and auto-fixes before every commit

set -e  # Exit on any error

echo "ðŸ”§ Running pre-commit quality checks..."

# Check if we're in the correct directory (project root)
if [ ! -f "Makefile" ]; then
    echo "âŒ Error: Not in project root directory. Pre-commit hook expects to run from project root."
    exit 1
fi

# 0. Branch policy enforcement (fast failure)
echo "ðŸ›¡ï¸  Checking branch naming policy and main branch protection..."
./scripts/git/protect-main-branch.sh
if [ $? -ne 0 ]; then
    echo "âŒ Main branch protection triggered"
    exit 1
fi

./scripts/git/validate-branch-name.sh
if [ $? -ne 0 ]; then
    echo "ðŸ’¡ To fix branch naming issues:"
    echo "   1. Get suggestion: ./scripts/git/validate-branch-name.sh $(git rev-parse --abbrev-ref HEAD) suggest"
    echo "   2. Rename branch: make branch-rename NAME=suggested-name"
    echo "   3. Or get detailed guidance: ./scripts/git/validate-branch-name.sh $(git rev-parse --abbrev-ref HEAD) promptlet"
    exit 1
fi

# 1. Cleanup temp files and organize project
echo "ðŸ“ Cleaning up temporary files..."
make cleanup
if [ $? -ne 0 ]; then
    echo "âŒ Cleanup failed"
    exit 1
fi

# 2. Auto-fix linting and formatting issues
echo "ðŸ› ï¸  Auto-fixing code issues..."
make fix
if [ $? -ne 0 ]; then
    echo "âš ï¸  Some auto-fixes failed, but continuing..."
fi

# 3. Stage any auto-fixes that were made
echo "ðŸ“ Staging auto-fixes..."
git add -A

# 4. Validate promptlet system compliance (comprehensive)
echo "ðŸ¤– Validating promptlet system compliance..."
./scripts/git/validate-promptlet-compliance.sh
if [ $? -ne 0 ]; then
    echo "âŒ Comprehensive promptlet validation failed!"
    echo "ðŸ’¡ Please fix violations above to ensure complete compliance."
    echo "ðŸ’¡ Check configuration in scripts/git/promptlet-sources.json"
    exit 1
fi

# 5. Verify no problematic files remain in staged changes
echo "ðŸ” Verifying clean commit..."
make verify
if [ $? -ne 0 ]; then
    echo "âŒ Pre-commit verification failed!"
    echo "ðŸ’¡ Please review the issues above and fix them before committing."
    echo "ðŸ’¡ You may need to run 'make cleanup' and 'make fix' manually."
    exit 1
fi

# 6. Enhanced commit metadata collection for incremental PR building
echo "ðŸ’¾ Caching enhanced commit metadata..."
CACHE_DIR=".git/commit-cache"
BRANCH_CACHE_DIR="$CACHE_DIR/branches"
mkdir -p "$CACHE_DIR" "$BRANCH_CACHE_DIR"

# Calculate base and branch info
BASE=$(git merge-base origin/main HEAD 2>/dev/null || git rev-list --max-parents=0 HEAD | tail -n1)
BRANCH=$(git rev-parse --abbrev-ref HEAD)
COMMIT_HASH=$(git rev-parse HEAD)
COMMIT_MSG=$(git log -1 --pretty=format:'%s')
COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
COMMIT_TIME=$(date +%s)

# Analyze current commit changes (staged files for this specific commit)
STAGED_FILES=$(git diff --cached --name-only | tr '\n' ' ' || true)
STAGED_STATS=$(git diff --cached --numstat | awk '{printf "%s:+%s/-%s ", $3, $1, $2}' || true)

# Categorize changes by type and scope
API_FILES=$(echo "$STAGED_FILES" | grep -E "(apps/api|\.py$)" | wc -l | tr -d ' ')
WEB_FILES=$(echo "$STAGED_FILES" | grep -E "(apps/web|\.tsx?$|\.js$)" | wc -l | tr -d ' ')
DOC_FILES=$(echo "$STAGED_FILES" | grep -E "\.md$|README" | wc -l | tr -d ' ')
CONFIG_FILES=$(echo "$STAGED_FILES" | grep -E "(\.json$|\.toml$|\.yml$|\.yaml$|Makefile|\.sh$)" | wc -l | tr -d ' ')
STYLE_FILES=$(echo "$STAGED_FILES" | grep -E "(\.css$|\.scss$)" | wc -l | tr -d ' ')

# Determine commit scope and impact
COMMIT_SCOPE="general"
if [ "$API_FILES" -gt 0 ] && [ "$WEB_FILES" -gt 0 ]; then
    COMMIT_SCOPE="fullstack"
elif [ "$API_FILES" -gt 0 ]; then
    COMMIT_SCOPE="api"
elif [ "$WEB_FILES" -gt 0 ]; then
    COMMIT_SCOPE="web"
elif [ "$DOC_FILES" -gt 0 ]; then
    COMMIT_SCOPE="docs"
elif [ "$CONFIG_FILES" -gt 0 ]; then
    COMMIT_SCOPE="config"
fi

# Extract commit type from conventional commit message
COMMIT_TYPE=$(echo "$COMMIT_MSG" | sed -E 's/^([a-z]+)(\(.+\))?:.*/\1/' || echo "unknown")

# Individual commit caching removed - git-cliff handles all commit analysis

# Store git-cliff based cache for ship workflow
CHANGELOG_VAL=$(git-cliff --unreleased --strip header 2>/dev/null | tr '\n' '|' || echo "No unreleased changes detected")

cat > "$CACHE_DIR/last-commit-meta" << EOF
BASE="$BASE"
BRANCH="$BRANCH"
COMMIT_TIME=$COMMIT_TIME
CHANGELOG_ENTRY="$CHANGELOG_VAL"
EOF

echo "âœ… Pre-commit checks passed! Metadata cached for efficient ship workflow."