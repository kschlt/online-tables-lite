#!/bin/bash

# Pre-commit hook for Online Tables Lite (Husky)
# Runs quality checks and auto-fixes before every commit

set -e  # Exit on any error

echo "ðŸ”§ Running pre-commit quality checks..."

# Check if we're in the correct directory (project root)
if [ ! -f "Makefile" ]; then
    echo "âŒ Error: Not in project root directory. Pre-commit hook expects to run from project root."
    exit 1
fi

# 0. Branch policy enforcement (fast failure)
echo "ðŸ›¡ï¸  Checking branch naming policy and main branch protection..."
./scripts/git/protect-main-branch.sh
if [ $? -ne 0 ]; then
    echo "âŒ Main branch protection triggered"
    exit 1
fi

./scripts/git/validate-branch-name.sh
if [ $? -ne 0 ]; then
    echo "ðŸ’¡ To fix branch naming issues:"
    echo "   1. Get suggestion: ./scripts/git/validate-branch-name.sh $(git rev-parse --abbrev-ref HEAD) suggest"
    echo "   2. Rename branch: make branch-rename NAME=suggested-name"
    echo "   3. Or get detailed guidance: ./scripts/git/validate-branch-name.sh $(git rev-parse --abbrev-ref HEAD) promptlet"
    exit 1
fi

# 1. Cleanup temp files and organize project
echo "ðŸ“ Cleaning up temporary files..."
make cleanup
if [ $? -ne 0 ]; then
    echo "âŒ Cleanup failed"
    exit 1
fi

# 2. Auto-fix linting and formatting issues
echo "ðŸ› ï¸  Auto-fixing code issues..."
make fix
if [ $? -ne 0 ]; then
    echo "âš ï¸  Some auto-fixes failed, but continuing..."
fi

# 3. Stage any auto-fixes that were made
echo "ðŸ“ Staging auto-fixes..."
git add -A

# 4. Verify no problematic files remain in staged changes
echo "ðŸ” Verifying clean commit..."
make verify
if [ $? -ne 0 ]; then
    echo "âŒ Pre-commit verification failed!"
    echo "ðŸ’¡ Please review the issues above and fix them before committing."
    echo "ðŸ’¡ You may need to run 'make cleanup' and 'make fix' manually."
    exit 1
fi

# 5. Cache commit metadata for ship workflow efficiency
echo "ðŸ’¾ Caching commit metadata for workflow optimization..."
CACHE_DIR=".git/commit-cache"
mkdir -p "$CACHE_DIR"

# Calculate base and diff info once
BASE=$(git merge-base origin/main HEAD 2>/dev/null || git rev-list --max-parents=0 HEAD | tail -n1)
BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Cache the expensive git operations with proper escaping
CH_CODE_VAL=$(git diff --name-only $BASE...HEAD -- 'apps/**' 'supabase/**' 'scripts/**' ':!**/*.md' 2>/dev/null | tr '\n' ' ' || true)
CH_DOCS_VAL=$(git diff --name-only $BASE...HEAD -- '**/*.md' 2>/dev/null | tr '\n' ' ' || true)
LOG_VAL=$(git log --pretty=format:'* %s (%h)' $BASE..HEAD 2>/dev/null | tr '\n' '|' || echo "No commits found")
STATS_VAL=$(git diff --numstat $BASE..HEAD 2>/dev/null | awk '{printf "- %s (+%s/-%s)\n", $3, $1, $2}' | tr '\n' '|' || echo "No changes")
CHANGELOG_VAL=$(git-cliff --unreleased --strip header 2>/dev/null | tr '\n' '|' || echo "No unreleased changes detected")

cat > "$CACHE_DIR/last-commit-meta" << EOF
BASE="$BASE"
BRANCH="$BRANCH"
COMMIT_TIME=$(date +%s)
CH_CODE="$CH_CODE_VAL"
CH_DOCS="$CH_DOCS_VAL"
LOG="$LOG_VAL"
STATS="$STATS_VAL"
CHANGELOG_ENTRY="$CHANGELOG_VAL"
EOF

echo "âœ… Pre-commit checks passed! Metadata cached for efficient ship workflow."