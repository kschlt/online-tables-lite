#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Get the branch being pushed to
while read local_ref local_sha remote_ref remote_sha; do
    # Extract branch name from remote_ref (e.g., refs/heads/production -> production)
    branch=$(echo "$remote_ref" | sed 's/refs\/heads\///')
    
    # Only run checks for production branch pushes
    if [ "$branch" = "production" ]; then
        echo "ğŸš¨ PRODUCTION PUSH DETECTED - Running comprehensive checks..."
        echo "Branch: $branch"
        echo "Local SHA: $local_sha"
        echo "Remote SHA: $remote_sha"
        
        # Run web app checks
        echo "ğŸ” Running web app checks..."
        cd apps/web
        if ! npm run check; then
            echo "âŒ Web app checks failed!"
            echo "ğŸ’¡ Fix the issues and try pushing again"
            echo "ğŸ’¡ Or go back to your feature branch to fix issues"
            exit 1
        fi
        
        if ! npm run build; then
            echo "âŒ Web app build failed!"
            echo "ğŸ’¡ Fix the build issues and try pushing again"
            echo "ğŸ’¡ Or go back to your feature branch to fix issues"
            exit 1
        fi
        
        echo "âœ… Web app checks passed!"
        
        # Run API checks
        echo "ğŸ” Running API checks..."
        cd ../api
        
        # Check if virtual environment exists
        if [ -d "venv" ]; then
            source venv/bin/activate
        else
            echo "âš ï¸ No virtual environment found, installing dependencies..."
            python3 -m venv venv
            source venv/bin/activate
            pip install -r requirements.txt
        fi
        
        if ! ruff check .; then
            echo "âŒ API linting checks failed!"
            echo "ğŸ’¡ Fix the linting issues and try pushing again"
            echo "ğŸ’¡ Or go back to your feature branch to fix issues"
            exit 1
        fi
        
        if ! ruff format --check .; then
            echo "âŒ API formatting checks failed!"
            echo "ğŸ’¡ Run 'ruff format .' to fix formatting issues"
            echo "ğŸ’¡ Or go back to your feature branch to fix issues"
            exit 1
        fi
        
        if ! python -c "import app; print('âœ… API structure validation passed')"; then
            echo "âŒ API structure validation failed!"
            echo "ğŸ’¡ Fix the API structure issues and try pushing again"
            echo "ğŸ’¡ Or go back to your feature branch to fix issues"
            exit 1
        fi
        
        echo "âœ… API checks passed!"
        
        # Go back to root
        cd ../..
        
        echo ""
        echo "ğŸ‰ ALL CHECKS PASSED!"
        echo "âœ… Web app: TypeScript, linting, formatting, build - OK"
        echo "âœ… API: Linting, formatting, structure - OK"
        echo "ğŸš€ Production push is safe to proceed"
        echo ""
        
        # Optional: Show what will be deployed
        echo "ğŸ“‹ Deployment summary:"
        echo "   - Web app will be deployed to Vercel"
        echo "   - API will be deployed to Fly.io"
        echo "   - All checks have been validated"
        echo ""
    else
        echo "â„¹ï¸ Pushing to branch: $branch (no production checks required)"
    fi
done
