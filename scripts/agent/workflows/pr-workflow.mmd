graph TD
    %% Entry Point
    UserTrigger["ðŸ‘¤ User: 'push', 'create PR'"]
    ClaudeExec["ðŸ¤– make pr-workflow"]

    %% Step 1: Validation
    ValidateStart["ðŸ” validate_changes"]
    CheckBranch{Protected branch?}
    CheckConflicts{Merge conflicts?}
    CheckCommits{Commits ahead?}
    CheckUncommitted{Uncommitted changes?}

    %% Validation Outcomes & Claude Actions
    BranchError["âŒ branch_protection_error promptlet"]
    ClaudeCreatesBranch["ðŸ¤– make branch-new NAME=feat/name"]

    ConflictError["âŒ conflict_resolution promptlet"]
    ClaudeResolves["ðŸ¤– git rebase main â†’ retry pr-workflow"]

    NoChanges["â„¹ï¸ no_changes promptlet"]
    ClaudeNoOp["ðŸ¤– No PR needed"]

    UncommittedPromptlet["âš ï¸ validation warning promptlet"]
    ClaudeCommitsFirst["ðŸ¤– make commit â†’ retry pr-workflow"]

    %% Step 2: Documentation
    DocsWorkflow["ðŸ“š docs-workflow.sh generate_docs"]
    CheckDocNeeded{Doc changes needed?}
    ApplyDocs["ðŸ“ apply_docs"]
    CommitDocs["ðŸ’¾ commit_docs"]
    SkipDocs["â­ï¸ Skip docs"]

    %% Step 3: Push & PR Creation
    PushBranch["ðŸ“¤ push_branch"]
    PrePushHook["ðŸ”— Pre-push hook: CHANGELOG update"]
    GeneratePRBody["ðŸ“‹ pr_body â†’ promptlet"]
    ClaudeCreatesPR["ðŸ¤– Processes PR description"]
    CreatePR["ðŸš€ create_pr"]
    CheckExistingPR{PR exists?}
    UpdatePR["ðŸ”„ Update existing PR"]
    NewPR["âœ¨ Create new PR"]

    %% Step 4: Finalization
    FinalizePR["âœ… finalize_pr"]
    CheckCI{CI passing?}
    WorkflowComplete["ðŸŽ‰ COMPLETE"]

    %% Flow Connections
    UserTrigger --> ClaudeExec
    ClaudeExec --> ValidateStart

    %% Validation Flow
    ValidateStart --> CheckBranch
    CheckBranch -->|Yes| BranchError
    CheckBranch -->|No| CheckConflicts
    CheckConflicts -->|Yes| ConflictError
    CheckConflicts -->|No| CheckCommits
    CheckCommits -->|0| NoChanges
    CheckCommits -->|>0| CheckUncommitted
    CheckUncommitted -->|Yes| UncommittedPromptlet
    CheckUncommitted -->|No| DocsWorkflow

    %% Claude Actions
    BranchError -.->|promptlet| ClaudeCreatesBranch
    ConflictError -.->|promptlet| ClaudeResolves
    NoChanges -.->|promptlet| ClaudeNoOp
    UncommittedPromptlet -.->|promptlet| ClaudeCommitsFirst

    %% Retry flows
    ClaudeCreatesBranch --> ValidateStart
    ClaudeResolves --> ValidateStart
    ClaudeCommitsFirst --> ValidateStart

    %% Documentation Flow
    DocsWorkflow --> CheckDocNeeded
    CheckDocNeeded -->|Yes| ApplyDocs
    CheckDocNeeded -->|No| SkipDocs
    ApplyDocs --> CommitDocs
    CommitDocs --> PushBranch
    SkipDocs --> PushBranch

    %% PR Creation Flow
    PushBranch --> PrePushHook
    PrePushHook --> GeneratePRBody
    GeneratePRBody -.->|promptlet| ClaudeCreatesPR
    ClaudeCreatesPR --> CreatePR
    CreatePR --> CheckExistingPR
    CheckExistingPR -->|Yes| UpdatePR
    CheckExistingPR -->|No| NewPR
    UpdatePR --> FinalizePR
    NewPR --> FinalizePR

    %% Finalization
    FinalizePR --> CheckCI
    CheckCI --> WorkflowComplete

    %% Styling
    classDef entryPoint fill:#e1f5fe
    classDef processStep fill:#e8f5e8
    classDef decisionNode fill:#fff3e0
    classDef errorNode fill:#ffcdd2
    classDef successNode fill:#c8e6c9
    classDef claudeAction fill:#f3e5f5

    class UserTrigger,ClaudeExec entryPoint
    class ValidateStart,DocsWorkflow,PushBranch,PrePushHook,CreatePR,FinalizePR,ApplyDocs,CommitDocs processStep
    class CheckBranch,CheckConflicts,CheckCommits,CheckUncommitted,CheckDocNeeded,CheckExistingPR,CheckCI decisionNode
    class BranchError,ConflictError,NoChanges,UncommittedPromptlet errorNode
    class WorkflowComplete,UpdatePR,NewPR successNode
    class ClaudeCreatesBranch,ClaudeResolves,ClaudeNoOp,ClaudeCommitsFirst,ClaudeCreatesPR claudeAction