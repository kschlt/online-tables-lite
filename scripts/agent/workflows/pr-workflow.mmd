graph TD
    %% Entry Point
    UserSays["User: 'push', 'create PR'"]
    ClaudeDetects["ðŸ¤– Claude detects trigger"]
    ClaudeExec["ðŸ¤– Claude executes: make pr-workflow"]

    %% Workflow Steps
    MakefilePR["Makefile dispatches to pr-workflow"]
    ValidateChanges["Validate branch changes"]

    %% Validation Decisions
    CheckBranch{Protected branch?}
    CheckConflicts{Merge conflicts?}
    CheckCommits{Commits ahead?}
    CheckUncommitted{Uncommitted changes?}

    %% Error Promptlets
    BranchError["Generate branch_protection_error promptlet"]
    ConflictError["Generate conflict_resolution promptlet"]
    NoChanges["Generate no_changes promptlet"]
    UncommittedPromptlet["Generate validation warning promptlet"]

    %% Claude Actions
    ClaudeCreatesBranch["ðŸ¤– Claude: create branch â†’ retry workflow"]
    ClaudeResolves["ðŸ¤– Claude: rebase main â†’ retry workflow"]
    ClaudeNoOp["ðŸ¤– Claude: understand no PR needed"]
    ClaudeCommitsFirst["ðŸ¤– Claude: commit changes â†’ retry workflow"]

    %% Documentation Flow
    DocsWorkflow["Documentation workflow"]
    CheckDocNeeded{Doc changes needed?}
    ApplyDocs["Apply documentation updates"]
    CommitDocs["Commit documentation"]
    SkipDocs["Skip documentation"]

    %% Push & PR Creation
    PushBranch["Push branch"]
    PrePushHook["Pre-push hook: CHANGELOG update"]
    GeneratePRBody["Generate PR body"]
    PRBodyPromptlet["Generate pr_description promptlet"]
    ClaudeProcessesPR["ðŸ¤– Claude: process PR description"]
    CreatePR["Create/Update PR"]
    CheckExistingPR{PR exists?}
    UpdatePR["Update existing PR"]
    NewPR["Create new PR"]

    %% Finalization
    FinalizePR["Finalize PR"]
    CheckCI{CI passing?}
    WorkflowComplete["Workflow Complete"]

    %% Entry Flow
    UserSays --> ClaudeDetects
    ClaudeDetects --> ClaudeExec
    ClaudeExec --> MakefilePR

    %% Workflow Flow
    MakefilePR --> ValidateChanges

    %% Validation Flow
    ValidateChanges --> CheckBranch
    CheckBranch -->|Yes| BranchError
    CheckBranch -->|No| CheckConflicts
    CheckConflicts -->|Yes| ConflictError
    CheckConflicts -->|No| CheckCommits
    CheckCommits -->|0| NoChanges
    CheckCommits -->|>0| CheckUncommitted
    CheckUncommitted -->|Yes| UncommittedPromptlet
    CheckUncommitted -->|No| DocsWorkflow

    %% Promptlet to Claude (ping-pong)
    BranchError -.->|promptlet| ClaudeCreatesBranch
    ConflictError -.->|promptlet| ClaudeResolves
    NoChanges -.->|promptlet| ClaudeNoOp
    UncommittedPromptlet -.->|promptlet| ClaudeCommitsFirst

    %% Claude Re-entry Points
    ClaudeCreatesBranch --> MakefilePR
    ClaudeResolves --> MakefilePR
    ClaudeCommitsFirst --> MakefilePR

    %% Documentation Flow
    DocsWorkflow --> CheckDocNeeded
    CheckDocNeeded -->|Yes| ApplyDocs
    CheckDocNeeded -->|No| SkipDocs
    ApplyDocs --> CommitDocs
    CommitDocs --> PushBranch
    SkipDocs --> PushBranch

    %% Push & PR Flow
    PushBranch --> PrePushHook
    PrePushHook --> GeneratePRBody
    GeneratePRBody --> PRBodyPromptlet

    %% Claude PR Processing (ping-pong)
    PRBodyPromptlet -.->|promptlet| ClaudeProcessesPR
    ClaudeProcessesPR --> CreatePR

    %% PR Creation Flow
    CreatePR --> CheckExistingPR
    CheckExistingPR -->|Yes| UpdatePR
    CheckExistingPR -->|No| NewPR
    UpdatePR --> FinalizePR
    NewPR --> FinalizePR

    %% Finalization
    FinalizePR --> CheckCI
    CheckCI --> WorkflowComplete

    %% Styling - Using Original Color Scheme
    classDef userLayer fill:#e1f5fe
    classDef agentLayer fill:#f3e5f5
    classDef processStep fill:#e8f5e8
    classDef decisionNode fill:#fff3e0
    classDef errorNode fill:#ffcdd2
    classDef successNode fill:#c8e6c9

    %% User Interaction (Blue)
    class UserSays userLayer

    %% Claude/Agent Actions (Purple)
    class ClaudeDetects,ClaudeExec,ClaudeCreatesBranch,ClaudeResolves,ClaudeNoOp,ClaudeCommitsFirst,ClaudeProcessesPR agentLayer

    %% Script Execution (Green)
    class MakefilePR,ValidateChanges,DocsWorkflow,ApplyDocs,CommitDocs,SkipDocs,PushBranch,PrePushHook,GeneratePRBody,CreatePR,UpdatePR,NewPR,FinalizePR processStep

    %% Decision Points (Yellow)
    class CheckBranch,CheckConflicts,CheckCommits,CheckUncommitted,CheckDocNeeded,CheckExistingPR,CheckCI decisionNode

    %% Promptlets (Red)
    class BranchError,ConflictError,NoChanges,UncommittedPromptlet,PRBodyPromptlet errorNode

    %% Success/Complete (Green)
    class WorkflowComplete successNode