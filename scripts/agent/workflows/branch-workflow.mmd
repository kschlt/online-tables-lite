flowchart TD
    %% Entry Point
    UserTrigger["User: 'create branch feat/feature-name'"]
    ClaudeDetects["ü§ñ Claude detects trigger"]
    ClaudeExec["ü§ñ Claude executes: make branch-new NAME=feat/feature-name"]

    %% State Validation
    CheckUncommitted{Uncommitted changes?}
    CheckStaged{Changes staged?}

    %% STOP CONDITIONS (Terminal Messages Only)
    CommitFirstStop["‚ùå STOP: Staged changes detected<br/>Terminal: Commit changes first<br/>USER ACTION REQUIRED: make commit"]
    StashFirstStop["‚ùå STOP: Unstaged changes detected<br/>Terminal: Stash changes first<br/>USER ACTION REQUIRED: git stash"]

    %% Main Branch Sync
    SwitchToMain["Switch to main branch"]
    UpdateMain["Fetch and pull latest main"]

    %% Validation Phase
    QueryGitHub["Query GitHub for open PRs"]
    CheckOpenPRs{Open PRs found?}
    OpenPRStop["‚ö†Ô∏è STOP: Open PRs detected<br/>Terminal: X open PRs found<br/>USER CHOICE: Continue anyway? (Y/N)"]

    ValidateName["Validate branch name format"]
    NameValid{Name format valid?}
    AutoFixName["Auto-fix common issues:<br/>‚Ä¢ Remove spaces/special chars<br/>‚Ä¢ Convert to lowercase<br/>‚Ä¢ Add missing prefix"]
    CheckAutoFixed{Auto-fix successful?}
    ClaudeFixesName["ü§ñ Claude generates compliant name"]

    %% Branch Creation
    CreateBranch["Create new branch"]
    WorkflowComplete["Workflow Complete"]

    %% Flow Connections
    UserTrigger --> ClaudeDetects
    ClaudeDetects --> ClaudeExec
    ClaudeExec --> CheckUncommitted

    %% State Validation Flow
    CheckUncommitted -->|Yes| CheckStaged
    CheckUncommitted -->|No| SwitchToMain
    CheckStaged -->|Yes| CommitFirstStop
    CheckStaged -->|No| StashFirstStop

    %% Main Branch Sync Flow
    SwitchToMain --> UpdateMain
    UpdateMain --> QueryGitHub

    %% Validation Flow
    QueryGitHub --> CheckOpenPRs
    CheckOpenPRs -->|Yes| OpenPRStop
    CheckOpenPRs -->|No| ValidateName
    OpenPRStop -.->|"User chooses Continue"| ValidateName

    %% Name Validation Flow
    ValidateName --> NameValid
    NameValid -->|Valid| CreateBranch
    NameValid -->|Invalid| AutoFixName
    AutoFixName --> CheckAutoFixed
    CheckAutoFixed -->|Success| CreateBranch
    CheckAutoFixed -->|Failed| ClaudeFixesName
    ClaudeFixesName --> ValidateName

    %% Success Flow
    CreateBranch --> WorkflowComplete

    %% Styling - Consistent with Other Workflows
    UserTrigger@{ shape: rect}
    UserTrigger:::userLayer
    ClaudeDetects:::agentLayer
    ClaudeExec:::agentLayer
    CheckUncommitted:::automationStep
    CheckStaged:::automationStep
    CommitFirstStop:::stopNode
    StashFirstStop:::stopNode
    SwitchToMain:::automationStep
    UpdateMain:::automationStep
    QueryGitHub:::automationStep
    CheckOpenPRs:::automationStep
    OpenPRStop:::stopNode
    ValidateName:::automationStep
    NameValid:::automationStep
    AutoFixName:::automationStep
    CheckAutoFixed:::automationStep
    ClaudeFixesName:::agentLayer
    CreateBranch:::automationStep
    WorkflowComplete:::successNode

    classDef userLayer fill:#e1f5fe
    classDef agentLayer fill:#f3e5f5
    classDef automationStep fill:#fff3e0
    classDef stopNode fill:#ffcdd2
    classDef successNode fill:#a5d6a7