graph TD
    %% Entry Point
    UserTrigger["ğŸ‘¤ User: 'create branch', 'new branch'"]
    ClaudeExec["ğŸ¤– make branch-new"]

    %% Current Branch Check
    CheckCurrentBranch{Current branch?}
    OnMain["âœ… On main"]
    OnFeature["ğŸ”„ On feature branch"]

    %% Uncommitted Changes
    CheckUncommitted{Uncommitted changes?}
    CheckStaged{Changes staged?}
    StagedPromptlet["ğŸ“‹ uncommitted_changes_handling<br/>'commit first'"]
    UnstagedPromptlet["ğŸ“‹ uncommitted_changes_handling<br/>'stash first'"]

    %% Claude Actions for Changes
    ClaudeCommits["ğŸ¤– make commit â†’ retry branch-new"]
    ClaudeStashes["ğŸ¤– git stash â†’ branch-new â†’ git stash pop"]

    %% Main Branch Update
    SwitchToMain["ğŸ”„ git checkout main"]
    FetchMain["ğŸ“¡ git fetch origin main"]
    CheckMainSync{Local == Remote?}
    UpdateMain["ğŸ”„ git pull origin main"]
    MainUpToDate["âœ… Main up to date"]

    %% Open PRs Check
    CheckPRs{Open PRs exist?}
    QueryGitHub["ğŸ” gh pr list --state open"]
    NoPRs["âœ… No open PRs"]
    ShowOpenPRs["âš ï¸ Found X open PRs"]
    OpenPRPromptlet["ğŸ“‹ branch_creation_with_open_prs<br/>coordination context"]
    ClaudeCoordinates["ğŸ¤– Consider existing work"]

    %% Branch Name Handling
    CheckNameProvided{Name provided?}
    ValidateName["ğŸ” validate-branch-name.sh"]
    NameValid{Name valid?}

    %% Name Generation & Fixing
    GenerateNamePromptlet["ğŸ“‹ branch_name_generation<br/>request descriptive name"]
    ClaudeGeneratesName["ğŸ¤– Provides: feat/feature-name"]
    CompliancePromptlet["ğŸ“‹ compliance guidance<br/>name violates policy"]
    ClaudeFixesName["ğŸ¤– Provides compliant name"]

    %% Branch Creation
    CreateBranch["ğŸŒ¿ git checkout -b BRANCH"]
    BranchSuccess["âœ… Branch created"]
    ShowNextSteps["ğŸ“ Ready for development:<br/>â€¢ Code features<br/>â€¢ 'commit' â†’ make commit<br/>â€¢ 'push' â†’ make pr-workflow"]

    %% Flow Connections
    UserTrigger --> ClaudeExec
    ClaudeExec --> CheckCurrentBranch

    %% Branch Check
    CheckCurrentBranch -->|main| CheckUncommitted
    CheckCurrentBranch -->|feature| OnFeature
    OnFeature --> CheckUncommitted

    %% Uncommitted Changes Flow
    CheckUncommitted -->|Yes| CheckStaged
    CheckUncommitted -->|No| SwitchToMain
    CheckStaged -->|Yes| StagedPromptlet
    CheckStaged -->|No| UnstagedPromptlet

    %% Claude Handles Changes
    StagedPromptlet -.->|promptlet| ClaudeCommits
    UnstagedPromptlet -.->|promptlet| ClaudeStashes
    ClaudeCommits --> SwitchToMain
    ClaudeStashes --> SwitchToMain

    %% Main Update Flow
    SwitchToMain --> FetchMain
    FetchMain --> CheckMainSync
    CheckMainSync -->|Different| UpdateMain
    CheckMainSync -->|Same| MainUpToDate
    UpdateMain --> CheckPRs
    MainUpToDate --> CheckPRs

    %% PR Check Flow
    CheckPRs --> QueryGitHub
    QueryGitHub -->|0| NoPRs
    QueryGitHub -->|>0| ShowOpenPRs
    ShowOpenPRs --> OpenPRPromptlet
    OpenPRPromptlet -.->|promptlet| ClaudeCoordinates
    ClaudeCoordinates --> CheckNameProvided
    NoPRs --> CheckNameProvided

    %% Name Validation Flow
    CheckNameProvided -->|Yes| ValidateName
    CheckNameProvided -->|No| GenerateNamePromptlet
    GenerateNamePromptlet -.->|promptlet| ClaudeGeneratesName
    ClaudeGeneratesName --> ValidateName
    ValidateName --> NameValid
    NameValid -->|Valid| CreateBranch
    NameValid -->|Invalid| CompliancePromptlet
    CompliancePromptlet -.->|promptlet| ClaudeFixesName
    ClaudeFixesName --> ValidateName

    %% Success Flow
    CreateBranch --> BranchSuccess
    BranchSuccess --> ShowNextSteps

    %% Styling
    classDef entryPoint fill:#e1f5fe
    classDef processStep fill:#e8f5e8
    classDef decisionNode fill:#fff3e0
    classDef errorNode fill:#ffcdd2
    classDef successNode fill:#c8e6c9
    classDef warningNode fill:#fff8e1
    classDef claudeAction fill:#f3e5f5

    class UserTrigger,ClaudeExec entryPoint
    class SwitchToMain,FetchMain,UpdateMain,QueryGitHub,ValidateName,CreateBranch,ClaudeCommits,ClaudeStashes,ClaudeCoordinates,ClaudeGeneratesName,ClaudeFixesName processStep
    class CheckCurrentBranch,CheckUncommitted,CheckStaged,CheckMainSync,CheckPRs,CheckNameProvided,NameValid decisionNode
    class CompliancePromptlet errorNode
    class BranchSuccess,ShowNextSteps,MainUpToDate,NoPRs successNode
    class OnFeature,ShowOpenPRs warningNode
    class StagedPromptlet,UnstagedPromptlet,OpenPRPromptlet,GenerateNamePromptlet claudeAction