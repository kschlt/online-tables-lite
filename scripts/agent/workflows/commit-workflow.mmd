flowchart TD
    %% Entry Point
    UserTrigger["User: 'commit', 'save changes'"]
    ClaudeDetects["ü§ñ Claude detects trigger"]
    ClaudeExec["ü§ñ Claude executes: make commit"]

    %% Makefile Validation
    CheckStaged{Staged files exist?}
    CheckUnstaged{Unstaged files exist?}

    %% STOP CONDITIONS (Terminal Messages Only)
    NoChanges["‚ÑπÔ∏è STOP: Working tree clean<br/>Terminal: No changes to commit<br/>WORKFLOW COMPLETE"]
    NoStaged["‚ùå STOP: No files staged<br/>Terminal: Use 'make stage' to stage files<br/>USER ACTION REQUIRED"]

    %% STAGING WORKFLOW (Black Box)
    subgraph StagingBox ["üìã STAGING WORKFLOW<br/>üìÑ <i>See: make stage implementation</i>"]
        direction TB
        StageEntry["Entry: make stage"]
        StageBlackBox["Staging automation handling:<br/>‚Ä¢ Intelligent file detection<br/>‚Ä¢ Agent staging decisions<br/>‚Ä¢ Auto-stage relevant files"]
        StageExit["Exit: Files staged, return to commit"]
        StageEntry --> StageBlackBox
        StageBlackBox --> StageExit
    end

    %% Message Generation (Makefile)
    CollectContext["Collect commit context:<br/>‚Ä¢ git-cliff preview<br/>‚Ä¢ Diff summary<br/>‚Ä¢ Allowed commit types"]
    ClaudeGenerates["ü§ñ Claude generates commit message"]

    %% Commit Execution & Validation
    ExecuteCommit["Execute commit with message"]
    ValidateFormat{Message format valid?}
    FormatWarning["‚ö†Ô∏è Format warning (continue)"]
    CheckStagedAgain{Files still staged?}
    CommitFailed["‚ùå STOP: No staged files<br/>Terminal: Files were unstaged<br/>USER ACTION REQUIRED"]

    %% PRE-COMMIT HOOKS (Black Box)
    subgraph PreCommitBox ["üîß PRE-COMMIT HOOKS<br/>üìÑ <i>See: .git/hooks/pre-commit</i>"]
        direction TB
        HookEntry["Entry: git commit execution"]
        HookBlackBox["Hook automation handling:<br/>‚Ä¢ Code formatting (prettier, ruff)<br/>‚Ä¢ Linting & style checks<br/>‚Ä¢ Type checking & validation"]
        HookExit["Exit: Success or failure"]
        HookEntry --> HookBlackBox
        HookBlackBox --> HookExit
    end

    %% Final Outcomes
    CommitSuccess["‚úÖ Commit successful"]
    HookFailed["‚ùå STOP: Pre-commit failed<br/>Terminal: Fix issues and retry<br/>USER ACTION REQUIRED"]
    WorkflowComplete["Workflow Complete"]

    %% Flow Connections
    UserTrigger --> ClaudeDetects
    ClaudeDetects --> ClaudeExec
    ClaudeExec --> CheckStaged

    %% Staging Validation
    CheckStaged -->|No| CheckUnstaged
    CheckStaged -->|Yes| CollectContext
    CheckUnstaged -->|No| NoChanges
    CheckUnstaged -->|Yes| NoStaged

    %% User goes to staging workflow (manual step)
    NoStaged -.->|"User runs 'make stage'"| StagingBox
    StageExit -.->|"User runs 'make commit' again"| CheckStaged

    %% Message Generation (happens in Makefile)
    CollectContext --> ClaudeGenerates
    ClaudeGenerates --> ExecuteCommit

    %% Commit Execution & Validation (happens in execute_commit)
    ExecuteCommit --> ValidateFormat
    ValidateFormat -->|Warning| FormatWarning
    ValidateFormat -->|Valid| CheckStagedAgain
    FormatWarning --> CheckStagedAgain
    CheckStagedAgain -->|No| CommitFailed
    CheckStagedAgain -->|Yes| PreCommitBox

    %% Pre-commit Hook Flow
    HookExit -->|Success| CommitSuccess
    HookExit -->|Failure| HookFailed

    %% Completion
    CommitSuccess --> WorkflowComplete

    %% Entry/Exit for Pre-commit Hooks
    HookEntry --> HookBlackBox
    HookBlackBox --> HookExit

    %% Entry/Exit for Staging and Pre-commit
    StageEntry --> StageBlackBox
    StageBlackBox --> StageExit

    %% Styling - Consistent with PR Workflow
    UserTrigger@{ shape: rect}
    StageEntry:::automationStep
    StageBlackBox:::blackBoxStep
    StageExit:::automationStep
    HookEntry:::automationStep
    HookBlackBox:::blackBoxStep
    HookExit:::automationStep
    UserTrigger:::userLayer
    ClaudeDetects:::agentLayer
    ClaudeExec:::agentLayer
    CheckStaged:::automationStep
    CheckUnstaged:::automationStep
    NoChanges:::stopNode
    NoStaged:::stopNode
    StagingBox:::subgraphStyle
    CollectContext:::automationStep
    ClaudeGenerates:::agentLayer
    ExecuteCommit:::automationStep
    ValidateFormat:::automationStep
    FormatWarning:::automationStep
    CheckStagedAgain:::automationStep
    CommitFailed:::stopNode
    PreCommitBox:::subgraphStyle
    CommitSuccess:::successNode
    HookFailed:::stopNode
    WorkflowComplete:::successNode

    classDef userLayer fill:#e1f5fe
    classDef agentLayer fill:#f3e5f5
    classDef automationStep fill:#fff3e0
    classDef stopNode fill:#ffcdd2
    classDef blackBoxStep fill:#f5f5f5
    classDef successNode fill:#a5d6a7
    classDef subgraphStyle fill:#f9f9f9,stroke:#666,stroke-width:2px,stroke-dasharray: 5 5