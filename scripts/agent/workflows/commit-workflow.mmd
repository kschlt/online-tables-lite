graph TD
    %% Entry Point
    UserTrigger["ğŸ‘¤ User: 'commit', 'save changes'"]
    ClaudeExec["ğŸ¤– make commit"]

    %% Makefile Validation
    CheckStaged{Staged files exist?}
    CheckUnstaged{Unstaged files exist?}
    NoChanges["â„¹ï¸ Working tree clean"]
    NoStaged["âŒ No files staged<br/>ğŸ’¡ Use 'make stage'"]

    %% Context Collection & Promptlet
    CollectContext["ğŸ” Collect commit context:<br/>â€¢ Staged files<br/>â€¢ git-cliff preview<br/>â€¢ Diff summary<br/>â€¢ Allowed types"]
    GeneratePromptlet["ğŸ“‹ conventional_commit_generation promptlet"]

    %% Claude Processing
    ClaudeProcesses["ğŸ¤– Claude generates commit message"]
    ClaudeExecutes["ğŸ¤– execute_commit --message 'type(scope): description'"]

    %% Commit Execution
    ExecuteCommit["ğŸš€ commit-workflow.sh execute_commit"]
    ValidateFormat{Message format valid?}
    FormatWarning["âš ï¸ Format warning"]
    CheckStagedAgain{Files still staged?}
    CommitFailed["âŒ No staged files"]

    %% Pre-commit Hook
    PreCommitHook["ğŸ”— Pre-commit hooks:<br/>â€¢ Formatting (prettier, ruff)<br/>â€¢ Linting<br/>â€¢ Type checking"]
    HookSuccess{Hooks passed?}

    %% Outcomes
    CommitSuccess["âœ… Commit successful"]
    HookFailed["âŒ Pre-commit failed"]
    WorkflowComplete["ğŸ‰ COMPLETE"]

    %% Flow Connections
    UserTrigger --> ClaudeExec
    ClaudeExec --> CheckStaged

    %% Staging Validation
    CheckStaged -->|No| CheckUnstaged
    CheckStaged -->|Yes| CollectContext
    CheckUnstaged -->|No| NoChanges
    CheckUnstaged -->|Yes| NoStaged

    %% Message Generation
    CollectContext --> GeneratePromptlet
    GeneratePromptlet -.->|promptlet| ClaudeProcesses
    ClaudeProcesses --> ClaudeExecutes
    ClaudeExecutes --> ExecuteCommit

    %% Commit Execution
    ExecuteCommit --> ValidateFormat
    ValidateFormat -->|Invalid| FormatWarning
    ValidateFormat -->|Valid| CheckStagedAgain
    FormatWarning --> CheckStagedAgain
    CheckStagedAgain -->|No| CommitFailed
    CheckStagedAgain -->|Yes| PreCommitHook

    %% Pre-commit Flow
    PreCommitHook --> HookSuccess
    HookSuccess -->|Yes| CommitSuccess
    HookSuccess -->|No| HookFailed

    %% Completion
    CommitSuccess --> WorkflowComplete

    %% Styling
    classDef entryPoint fill:#e1f5fe
    classDef processStep fill:#e8f5e8
    classDef decisionNode fill:#fff3e0
    classDef errorNode fill:#ffcdd2
    classDef successNode fill:#c8e6c9
    classDef warningNode fill:#fff8e1
    classDef claudeAction fill:#f3e5f5

    class UserTrigger,ClaudeExec entryPoint
    class CollectContext,ExecuteCommit,PreCommitHook,ClaudeExecutes processStep
    class CheckStaged,CheckUnstaged,ValidateFormat,CheckStagedAgain,HookSuccess decisionNode
    class NoChanges,NoStaged,CommitFailed,HookFailed errorNode
    class CommitSuccess,WorkflowComplete successNode
    class FormatWarning warningNode
    class GeneratePromptlet,ClaudeProcesses claudeAction