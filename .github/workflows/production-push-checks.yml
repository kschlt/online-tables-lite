name: Production Push Validation

on:
  push:
    branches: [ production ]
  pull_request:
    branches: [ production ]

permissions:
  contents: read

concurrency:
  group: production-checks-${{ github.ref }}
  cancel-in-progress: true

jobs:
  production-validation:
    name: Production Branch Validation
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Web App Production Checks
        working-directory: apps/web
        run: |
          # Setup Node.js
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs
          
          # Install dependencies
          npm ci
          
          # Run comprehensive checks
          echo "ğŸ” Running TypeScript type check..."
          npm run typecheck
          
          echo "ğŸ” Running ESLint check..."
          npm run lint
          
          echo "ğŸ” Running Prettier format check..."
          npm run format:check
          
          echo "ğŸ” Running build check..."
          npm run build
          
          echo "âœ… Web app production checks passed!"
      
      - name: API Production Checks
        working-directory: apps/api
        run: |
          # Setup Python
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          
          # Install dependencies
          pip3 install -r requirements.txt
          
          # Run comprehensive checks
          echo "ğŸ” Running Ruff linting..."
          ruff check .
          
          echo "ğŸ” Running Ruff formatting check..."
          ruff format --check .
          
          echo "ğŸ” Running API structure validation..."
          python3 -c "import app; print('âœ… API structure validation passed')"
          
          echo "âœ… API production checks passed!"
      
      - name: Production Readiness Summary
        run: |
          echo ""
          echo "ğŸ‰ PRODUCTION BRANCH VALIDATION COMPLETE!"
          echo "âœ… All checks passed - production is ready for deployment"
          echo ""
          echo "ğŸ“‹ Validation Summary:"
          echo "   âœ… Web App: TypeScript âœ“ Linting âœ“ Formatting âœ“ Build âœ“"
          echo "   âœ… API: Linting âœ“ Formatting âœ“ Structure âœ“"
          echo ""
          echo "ğŸš€ Production deployments will now proceed automatically"
          echo "   - Web app â†’ Vercel"
          echo "   - API â†’ Fly.io"
